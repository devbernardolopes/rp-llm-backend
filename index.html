<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RP LLM BACKEND</title>
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5021422329745536"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app-shell">
      <aside id="left-pane" class="expanded">
        <button id="pane-toggle" class="icon-btn" title="Collapse pane" aria-label="Toggle pane">&lt;</button>

        <div class="pane-top">
          <div class="pane-top-header">
            <button id="create-character-btn" class="primary-btn pane-create-char-btn">
              + Character
            </button>
            <button id="import-character-btn" class="secondary-btn pane-create-char-btn">
              ‚Ü• Import Character
            </button>
            <input id="import-character-input" type="file" accept=".json,application/json" class="hidden" />
          </div>
          <div id="thread-list" class="thread-list"></div>
        </div>

        <div class="pane-bottom">
          <button class="option-btn" data-open-modal="settings-modal" title="Settings" aria-label="Settings">‚öôÔ∏è</button>
          <button class="option-btn" data-open-modal="personas-modal" title="Personas" aria-label="Personas">üë§</button>
          <button class="option-btn" data-open-modal="lore-modal" title="Lore Books" aria-label="Lore Books">üìö</button>
          <button class="option-btn" data-open-modal="shortcuts-modal" title="Shortcuts" aria-label="Shortcuts">‚å®Ô∏è</button>
          <button class="option-btn" data-open-modal="tags-modal" title="Tags" aria-label="Tags">üè∑Ô∏è</button>
        </div>
      </aside>

      <main id="main-view" class="view active">
        <header class="main-header">
          <h1>RP LLM BACKEND</h1>
        </header>
        <section id="character-filters" class="character-filters">
          <div class="character-filters-row">
            <input
              id="character-tag-filter-input"
              list="tag-presets"
              type="text"
              placeholder="Filter by tag"
            />
            <button id="character-tag-filter-clear" class="secondary-btn" type="button">
              Clear
            </button>
            <select id="character-sort-select" aria-label="Character ordering">
              <option value="updated_desc">Last Modified: Newest</option>
              <option value="updated_asc">Last Modified: Oldest</option>
              <option value="created_desc">Created: Newest</option>
              <option value="created_asc">Created: Oldest</option>
              <option value="threads_desc">Threads: Most</option>
              <option value="threads_asc">Threads: Least</option>
              <option value="name_asc">Name: A-Z</option>
              <option value="name_desc">Name: Z-A</option>
            </select>
          </div>
          <div id="character-tag-filter-chips" class="filter-chips"></div>
          <div id="character-filter-active-cue" class="filter-active-cue hidden">
            Tag filters active.
          </div>
        </section>
        <section id="character-grid" class="character-grid"></section>
      </main>

      <section id="chat-view" class="view">
        <header class="chat-header">
          <button id="back-to-main" class="secondary-btn">Back</button>
          <button
            id="edit-current-character-btn"
            class="icon-btn"
            title="Edit current character"
            aria-label="Edit current character"
          ></button>
          <div id="chat-title">Thread</div>
          <button
            id="rename-thread-btn"
            class="icon-btn"
            title="Rename thread"
            aria-label="Rename thread"
          ></button>
          <div id="chat-model-pill" class="model-pill">Model: -</div>
        </header>

        <div id="chat-log" class="chat-log"></div>
        <button
          id="scroll-bottom-btn"
          class="icon-btn hidden"
          title="Scroll to bottom"
          aria-label="Scroll to bottom"
        >‚Üì</button>

        <div id="prompt-history-popover" class="popover hidden" role="dialog" aria-label="Prompt history">
          <div class="popover-title">Previous prompts</div>
          <div id="prompt-history-list" class="prompt-history-list"></div>
        </div>

        <div id="shortcuts-bar" class="shortcuts-bar"></div>

        <div class="input-row">
          <div class="prompt-col">
            <textarea
              id="user-input"
              rows="3"
              placeholder="What do you say or do? Enter to send, Shift+Enter for newline"
            ></textarea>
          </div>
          <div class="send-col">
            <label class="persona-picker in-send-col">
              <div class="persona-inline">
                <img id="persona-selected-avatar" class="persona-selected-avatar" alt="Persona avatar" />
                <select id="persona-select" aria-label="Select persona"></select>
              </div>
            </label>
            <button id="send-btn" class="primary-btn">Send</button>
            <button id="shortcuts-toggle-btn" class="secondary-btn" type="button">Hide Shortcuts</button>
            <label class="checkbox-line auto-reply-line">
              <input type="checkbox" id="auto-reply-enabled" checked />
              Auto-reply
            </label>
            <label class="checkbox-line auto-reply-line">
              <input type="checkbox" id="enter-to-send-enabled" checked />
              ENTER to send
            </label>
          </div>
        </div>
      </section>
    </div>

    <div id="modal-layer"></div>

    <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div id="confirm-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="confirm-title">Confirm</h3>
          <button class="icon-btn modal-close" id="confirm-cancel-btn" aria-label="Close confirmation">&times;</button>
        </div>
        <div class="modal-body">
          <p id="confirm-message"></p>
        </div>
        <div class="modal-footer">
          <button id="confirm-no-btn" class="secondary-btn">Cancel</button>
          <button id="confirm-yes-btn" class="primary-btn">Confirm</button>
        </div>
      </div>
    </div>

    <div id="text-input-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="text-input-title">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="text-input-title">Rename</h3>
          <button class="icon-btn modal-close" id="text-input-cancel-x" aria-label="Close input modal">&times;</button>
        </div>
        <div class="modal-body">
          <label>
            <span id="text-input-label">Value</span>
            <input id="text-input-value" type="text" maxlength="128" />
          </label>
        </div>
        <div class="modal-footer">
          <button id="text-input-cancel" class="secondary-btn">Cancel</button>
          <button id="text-input-save" class="primary-btn">Save</button>
        </div>
      </div>
    </div>

    <div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="settings-title">Settings</h3>
          <button class="icon-btn modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
          <label>
            Interface Language
            <select id="ui-language-select">
              <option value="auto">Auto (browser)</option>
              <option value="en">English</option>
              <option value="fr">Fran√ßais</option>
              <option value="it">Italiano</option>
              <option value="de">Deutsch</option>
              <option value="es">Espa√±ol</option>
              <option value="pt-BR">Portugu√™s (Brasil)</option>
            </select>
          </label>
          <label>
            OpenRouter API Key
            <input
              id="openrouter-api-key"
              type="password"
              placeholder="sk-or-v1-..."
              autocomplete="off"
              spellcheck="false"
            />
          </label>
          <label>
            Model
            <select id="model-select"></select>
          </label>
          <label>
            <div class="label-inline">
              <span>Max Tokens</span>
              <span id="max-tokens-value" class="muted"></span>
            </div>
            <input
              id="max-tokens-slider"
              type="range"
              min="512"
              max="16384"
              step="64"
            />
          </label>
          <label>
            <div class="label-inline">
              <span>Temperature</span>
              <span id="temperature-value" class="muted"></span>
            </div>
            <input
              id="temperature-slider"
              type="range"
              min="0"
              max="2"
              step="0.05"
            />
          </label>
          <div class="settings-inline-row">
            <button id="puter-signin-btn" class="secondary-btn" type="button">
              Sign In to Puter
            </button>
            <span id="puter-auth-status" class="muted">Puter: unknown</span>
          </div>
          <label>
            TTS Test Text
            <textarea
              id="tts-test-text"
              rows="2"
              placeholder="This is a test voice playback."
            ></textarea>
          </label>
          <div class="settings-inline-row">
            <button id="tts-test-play-btn" class="secondary-btn" type="button">
              Play TTS Test
            </button>
            <span id="tts-test-status" class="muted">TTS: idle</span>
          </div>
          <label class="checkbox-line">
            <input type="checkbox" id="markdown-enabled" />
            Render Markdown in messages
          </label>
          <label class="checkbox-line">
            <input type="checkbox" id="allow-message-html" />
            Allow raw HTML in messages
          </label>
          <label class="checkbox-line">
            <input type="checkbox" id="stream-enabled" checked />
            Stream Messages
          </label>
          <label class="checkbox-line">
            <input type="checkbox" id="autopair-enabled" checked />
            Auto-pair editor symbols
          </label>
          <label>
            Markdown Custom CSS
            <textarea
              id="markdown-custom-css"
              rows="6"
              placeholder=".md-em { color: #E6D97A; }"
            ></textarea>
          </label>
          <label>
            Post-processing Rules (JSON)
            <textarea
              id="postprocess-rules-json"
              rows="8"
              placeholder='[{"pattern":"^¬´([\\s\\S]*)¬ª$","flags":"gm","replacement":"<span style=\"color:#E6D97A\">¬´$1¬ª</span>"}]'
            ></textarea>
          </label>
          <label class="checkbox-line">
            <input type="checkbox" id="prefer-free-variant" />
            Prefer `:free` model variant when available
          </label>
          <label>
            Cancel Generation Shortcut
            <input id="cancel-shortcut" type="text" placeholder="Ctrl+." />
          </label>
          <label>
            Go Home Shortcut
            <input id="home-shortcut" type="text" placeholder="Alt+H" />
          </label>
          <label>
            New Character Shortcut
            <input id="new-character-shortcut" type="text" placeholder="Alt+N" />
          </label>
          <label>
            Default Character Prompt
            <textarea
              id="global-prompt-template"
              rows="7"
              placeholder="Used when a character prompt is empty."
            ></textarea>
          </label>
          <label>
            Memory Summarizer System Prompt
            <textarea
              id="summary-system-prompt"
              rows="3"
              placeholder="System prompt for memory summarization."
            ></textarea>
          </label>
          <label>
            Persona Injection Template
            <textarea
              id="persona-injection-template"
              rows="5"
              placeholder="Template for active persona injection."
            ></textarea>
          </label>
          <label>
            Persona Injection Timing
            <select id="persona-injection-when">
              <option value="always">Always</option>
              <option value="on_change">On Persona Change (first message always injects)</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div id="personas-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="personas-title">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="personas-title">Personas</h3>
          <button class="icon-btn modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
          <label>
            <div class="label-inline">
              <span>Name</span>
              <span id="persona-name-count" class="muted">0/128</span>
            </div>
            <input id="persona-name" type="text" maxlength="128" />
          </label>
          <label>
            Avatar URL
            <input id="persona-avatar" type="text" placeholder="optional" />
          </label>
          <label>
            Avatar File
            <input id="persona-avatar-file" type="file" accept="image/*" />
          </label>
          <label>
            Description (max 100 words)
            <textarea id="persona-description" rows="3"></textarea>
          </label>
          <label class="checkbox-line">
            <input id="persona-is-default" type="checkbox" />
            Set as default persona
          </label>
          <button id="save-persona-btn" class="primary-btn">Save Persona</button>
          <div id="persona-list" class="check-list"></div>
        </div>
      </div>
    </div>

    <div id="lore-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="lore-title">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="lore-title">Lore Books</h3>
          <button class="icon-btn modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
          <p class="muted">Lore book management will be added here.</p>
        </div>
      </div>
    </div>

    <div id="shortcuts-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="shortcuts-title">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="shortcuts-title">Shortcuts</h3>
          <button class="icon-btn modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
          <label>
            Shortcut Entries
            <textarea id="shortcuts-raw" rows="14"></textarea>
          </label>
          <button id="save-shortcuts-btn" class="primary-btn">Save Shortcuts</button>
        </div>
      </div>
    </div>

    <div id="tags-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="tags-title">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="tags-title">Tag Manager</h3>
          <button class="icon-btn modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body">
          <label>
            Custom tags (one per line)
            <textarea id="tags-custom-raw" rows="12"></textarea>
          </label>
          <p class="muted">Predefined tags are always available. Add your own tags here.</p>
        </div>
        <div class="modal-footer">
          <button class="secondary-btn" data-close-modal>Cancel</button>
          <button id="save-tags-btn" class="primary-btn">Save Tags</button>
        </div>
      </div>
    </div>

    <div id="character-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="character-title">
      <div class="modal-card wide">
        <div class="modal-header">
          <h3 id="character-title">Create Character</h3>
          <button class="icon-btn modal-close" data-close-modal>&times;</button>
        </div>
        <div class="modal-body two-col">
          <label>
            <div class="label-inline">
              <span>Name</span>
              <span id="char-name-count" class="muted">0/128</span>
            </div>
            <input id="char-name" type="text" maxlength="128" />
          </label>
          <label>
            Avatar URL
            <input id="char-avatar" type="text" placeholder="optional" />
          </label>
          <label class="full">
            Avatar File
            <input id="char-avatar-file" type="file" accept="image/*" />
          </label>
          <label class="full">
            <img id="char-avatar-preview" class="character-avatar-preview" alt="Avatar preview" />
          </label>
          <label class="full">
            Character Prompt
            <textarea id="char-system-prompt" rows="8"></textarea>
          </label>
          <label class="full">
            Default User Persona Override (Character-only)
            <select id="char-default-persona-override"></select>
          </label>
          <label class="full">
            One-time only Extra System/Character Prompt
            <textarea
              id="char-one-time-extra-prompt"
              rows="4"
              placeholder="Appended only for the first assistant generation."
            ></textarea>
          </label>
          <label class="full">
            Writing Instructions
            <textarea
              id="char-writing-instructions"
              rows="4"
              placeholder="Reserved for future implementation."
              disabled
            ></textarea>
          </label>
          <label class="full">
            Initial Messages
            <textarea
              id="char-initial-messages"
              rows="8"
              placeholder="[AI]: text...

[USER]: text...

[SYSTEM]: text..."
            ></textarea>
          </label>
          <label class="full">
            Tags (comma-separated)
            <input
              id="char-tags-input"
              list="tag-presets"
              type="text"
              placeholder="Roleplay, Female, Hero"
            />
            <div id="char-tags-presets" class="tag-presets-list"></div>
          </label>
          <label class="full">
            Persona Injection Placement
            <select id="char-persona-injection-placement">
              <option value="end_system_prompt">At End of Character Prompt</option>
            </select>
          </label>
          <label>
            <span class="checkbox-line">
              <input id="char-use-memory" type="checkbox" />
              Enable Memory
            </span>
          </label>
          <label>
            <span class="checkbox-line">
              <input id="char-use-postprocess" type="checkbox" checked />
              Enable Post-processing Rules
            </span>
          </label>
          <label>
            Avatar Scale (In Chat)
            <select id="char-avatar-scale">
              <option value="1">1x</option>
              <option value="2">2x</option>
              <option value="3">3x</option>
              <option value="4">4x</option>
            </select>
          </label>
          <label>
            TTS Language
            <select id="char-tts-language"></select>
          </label>
          <label>
            TTS Voice
            <select id="char-tts-voice"></select>
          </label>
          <label>
            <div class="label-inline">
              <span>TTS Rate</span>
              <span id="char-tts-rate-value" class="muted"></span>
            </div>
            <input id="char-tts-rate" type="range" min="0.5" max="2" step="0.1" />
          </label>
          <label>
            <div class="label-inline">
              <span>TTS Pitch</span>
              <span id="char-tts-pitch-value" class="muted"></span>
            </div>
            <input id="char-tts-pitch" type="range" min="0" max="2" step="0.1" />
          </label>
          <label class="full">
            <button id="char-tts-test-btn" class="secondary-btn" type="button">
              Test Character Voice
            </button>
          </label>
          <label class="full">
            Lore Books for this character
            <div id="char-lorebooks-list" class="check-list"></div>
          </label>
        </div>
        <div class="modal-footer">
          <button class="secondary-btn" data-close-modal>Cancel</button>
          <button id="save-character-btn" class="primary-btn">Save</button>
        </div>
      </div>
    </div>

    <datalist id="tag-presets"></datalist>

    <div id="image-preview-modal" class="modal hidden image-preview-modal" role="dialog" aria-modal="true" aria-label="Image preview">
      <div class="modal-card image-preview-card">
        <img id="image-preview-img" alt="Preview" />
      </div>
    </div>

    <div id="message-metadata-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="message-metadata-title">
      <div class="modal-card wide">
        <div class="modal-header">
          <h3 id="message-metadata-title">Message Metadata</h3>
          <button class="icon-btn modal-close" data-close-modal aria-label="Close metadata">&times;</button>
        </div>
        <div class="modal-body">
          <pre id="message-metadata-json" class="metadata-json"></pre>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <script src="https://js.puter.com/v2/"></script>
    <script src="config.js"></script>
    <script src="db.js"></script>
    <script src="app.js"></script>
  </body>
</html>
